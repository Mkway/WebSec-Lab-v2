name: ğŸ§ª ê°„ë‹¨í•œ API í…ŒìŠ¤íŠ¸

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    name: ğŸ’¨ ì—°ê¸° í…ŒìŠ¤íŠ¸ (ê¸°ë³¸ ë™ì‘ í™•ì¸)
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ğŸ³ Docker Compose ì„¤ì¹˜
      run: |
        sudo curl -L "https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose

    - name: ğŸš€ ì„œë¹„ìŠ¤ ì‹œì‘
      run: |
        cp .env.example .env
        docker-compose up -d
        sleep 30  # ì„œë¹„ìŠ¤ê°€ ì™„ì „íˆ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°

    - name: ğŸ” ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
      run: |
        docker-compose ps
        docker-compose logs

    - name: ğŸ’¨ ì—°ê¸° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        chmod +x scripts/smoke-test.sh
        ./scripts/smoke-test.sh

    - name: ğŸ§ª API í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ê¸°ë³¸)
      run: |
        # ê¸°ë³¸ í—¬ìŠ¤ì²´í¬ë§Œ ì‹¤í–‰ (ë³µì¡í•œ í…ŒìŠ¤íŠ¸ ì œì™¸)
        curl -f http://localhost:8080/health
        curl -f http://localhost:8080/

    - name: ğŸ›‘ ì„œë¹„ìŠ¤ ì •ë¦¬
      if: always()
      run: |
        docker-compose down -v
        docker system prune -f

  security-check:
    runs-on: ubuntu-latest
    name: ğŸ”’ ê¸°ë³¸ ë³´ì•ˆ ì²´í¬
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ” Docker ì´ë¯¸ì§€ ë³´ì•ˆ ìŠ¤ìº”
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        exit-code: '0'  # ê²½ê³ ë§Œ í‘œì‹œ, ì‹¤íŒ¨í•˜ì§€ ì•ŠìŒ

    - name: ğŸ“‹ í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ê²€ì‚¬
      run: |
        # ê°„ë‹¨í•œ íŒ¨í„´ ê²€ì‚¬ (ì™„ë²½í•˜ì§€ ì•Šì§€ë§Œ ê¸°ë³¸ì ì¸ ì²´í¬)
        if grep -r "password.*=" . --include="*.php" --include="*.js" --include="*.py" | grep -v "example\|test\|demo"; then
          echo "âš ï¸ í•˜ë“œì½”ë”©ëœ íŒ¨ìŠ¤ì›Œë“œ ë°œê²¬ ê°€ëŠ¥ì„±"
        fi
        
        if grep -r "api_key.*=" . --include="*.php" --include="*.js" --include="*.py" | grep -v "example\|test\|demo"; then
          echo "âš ï¸ í•˜ë“œì½”ë”©ëœ API í‚¤ ë°œê²¬ ê°€ëŠ¥ì„±"
        fi