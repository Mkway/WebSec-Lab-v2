// ì·¨ì•½ì ë³„ ê²°ê³¼ ë Œë”ë§ ëª¨ë“ˆ
class VulnerabilityRenderer {

    // SQL Injection ê²°ê³¼ ë Œë”ë§
    static renderSQLInjection(result) {
        const { data, mode, language, requestData } = result;
        const server = SERVERS[language];
        const isVulnerable = mode === 'vulnerable';

        // ê³µê²© ì„±ê³µ ì—¬ë¶€ íŒë‹¨
        const attackSuccess = data?.result?.authentication_bypassed ||
                             data?.data?.attack_success ||
                             data?.success === true;

        return `
            <div class="vulnerability-section">
                <h4>ğŸ’‰ SQL Injection ë¶„ì„</h4>

                ${isVulnerable && attackSuccess ? `
                    <div class="alert alert-danger">
                        <strong>âš ï¸ ì¸ì¦ ìš°íšŒ ì„±ê³µ!</strong> SQL ì¸ì ì…˜ìœ¼ë¡œ ë¡œê·¸ì¸ì„ ìš°íšŒí–ˆìŠµë‹ˆë‹¤.
                    </div>
                ` : ''}

                <div class="code-section">
                    <h5>ğŸ“ ì·¨ì•½í•œ ì½”ë“œ ì˜ˆì‹œ</h5>
                    <pre><code class="language-sql">-- ì·¨ì•½í•œ ì¿¼ë¦¬ (ì‚¬ìš©ì ì…ë ¥ ì§ì ‘ ì‚½ì…)
SELECT * FROM users
WHERE username = '${requestData.username}'
  AND password = '${requestData.password}'

-- ì‹¤ì œ ì‹¤í–‰ëœ ì¿¼ë¦¬ (ì¸ì ì…˜ ì ìš©ë¨)
SELECT * FROM users
WHERE username = 'admin' OR '1'='1'
  AND password = '' OR '1'='1'</code></pre>
                </div>

                <div class="analysis-section">
                    <h5>ğŸ” ì·¨ì•½ì  ë¶„ì„</h5>
                    <ul>
                        <li><strong>ì›ì¸:</strong> ì‚¬ìš©ì ì…ë ¥ì„ SQL ì¿¼ë¦¬ì— ì§ì ‘ ì‚½ì…</li>
                        <li><strong>ê³µê²© ë²¡í„°:</strong> OR ì¡°ê±´ìœ¼ë¡œ ì¸ì¦ ìš°íšŒ</li>
                        <li><strong>ìœ„í—˜ë„:</strong> ë†’ìŒ (ë°ì´í„°ë² ì´ìŠ¤ ì „ì²´ ì ‘ê·¼ ê°€ëŠ¥)</li>
                    </ul>
                </div>

                <div class="mitigation-section">
                    <h5>ğŸ›¡ï¸ ë³´ì•ˆ ëŒ€ì±…</h5>
                    <pre><code class="language-php">// ì•ˆì „í•œ ì½”ë“œ (Prepared Statement)
$stmt = $pdo->prepare("SELECT * FROM users WHERE username = ? AND password = ?");
$stmt->execute([$username, $password]);</code></pre>
                </div>
            </div>
        `;
    }

    // XSS ê²°ê³¼ ë Œë”ë§
    static renderXSS(result) {
        const { data, mode, language, requestData } = result;
        const server = SERVERS[language];
        const isVulnerable = mode === 'vulnerable';

        const xssDetected = data?.result?.xss_detected;
        const htmlOutput = data?.result?.html_output;
        const riskLevel = data?.analysis?.risk_level || 'medium';

        return `
            <div class="vulnerability-section">
                <h4>ğŸ”¥ Cross-Site Scripting (XSS) ë¶„ì„</h4>

                ${isVulnerable && xssDetected ? `
                    <div class="alert alert-danger">
                        <strong>âš ï¸ XSS ì·¨ì•½ì  ë°œê²¬!</strong> ì•…ì„± ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤í–‰ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>
                ` : ''}

                ${isVulnerable && htmlOutput ? `
                    <div class="xss-preview">
                        <h5>ğŸ¯ XSS ì‹¤í–‰ ê²°ê³¼</h5>
                        <div class="xss-demo-container">
                            <div class="demo-label">ì„œë²„ì—ì„œ ì²˜ë¦¬ëœ ê²°ê³¼:</div>
                            <div class="xss-output">${htmlOutput}</div>
                            <div class="xss-live-demo">
                                <strong>âš ï¸ ì‹¤ì œ XSS ì‹¤í–‰:</strong>
                                <div class="xss-execution-area">${htmlOutput}</div>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <div class="code-section">
                    <h5>ğŸ“ ì·¨ì•½í•œ ì½”ë“œ ì˜ˆì‹œ</h5>
                    <pre><code class="language-php">// ì·¨ì•½í•œ ì½”ë“œ (ì…ë ¥ê°’ ì§ì ‘ ì¶œë ¥)
echo "<div>ì‚¬ìš©ì ì…ë ¥: " . $_POST['search'] . "</div>";

// ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’: ${requestData.payload}
// ê²°ê³¼: ${htmlOutput}</code></pre>
                </div>

                <div class="analysis-section">
                    <h5>ğŸ” í˜ì´ë¡œë“œ ë¶„ì„</h5>
                    ${this.renderPayloadAnalysis(data?.analysis?.payload_analysis)}
                </div>

                <div class="mitigation-section">
                    <h5>ğŸ›¡ï¸ ë³´ì•ˆ ëŒ€ì±…</h5>
                    <pre><code class="language-php">// ì•ˆì „í•œ ì½”ë“œ (HTML ì´ìŠ¤ì¼€ì´í”„)
echo "<div>ì‚¬ìš©ì ì…ë ¥: " . htmlspecialchars($_POST['search'], ENT_QUOTES, 'UTF-8') . "</div>";

// ë˜ëŠ” í…œí”Œë¦¿ ì—”ì§„ ì‚¬ìš©
echo $twig->render('search.html', ['query' => $search]);</code></pre>
                </div>

                <div class="recommendations-section">
                    <h5>ğŸ’¡ ê¶Œì¥ì‚¬í•­</h5>
                    ${this.renderRecommendations(data?.analysis?.recommendations)}
                </div>
            </div>
        `;
    }

    // í˜ì´ë¡œë“œ ë¶„ì„ ë Œë”ë§
    static renderPayloadAnalysis(analysis) {
        if (!analysis) return '<p>ë¶„ì„ ë°ì´í„° ì—†ìŒ</p>';

        return `
            <div class="payload-analysis">
                <div class="analysis-grid">
                    <div class="analysis-item">
                        <span class="label">í˜ì´ë¡œë“œ ê¸¸ì´:</span>
                        <span class="value">${analysis.length} ë¬¸ì</span>
                    </div>
                    <div class="analysis-item">
                        <span class="label">ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸:</span>
                        <span class="value ${analysis.contains_script_tags ? 'danger' : 'safe'}">
                            ${analysis.contains_script_tags ? 'âš ï¸ í¬í•¨' : 'âœ… ì—†ìŒ'}
                        </span>
                    </div>
                    <div class="analysis-item">
                        <span class="label">ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬:</span>
                        <span class="value">${analysis.contains_event_handlers} ê°œ</span>
                    </div>
                    <div class="analysis-item">
                        <span class="label">ì¸ì½”ë”© ìƒíƒœ:</span>
                        <span class="value">
                            ${analysis.encoding_detected?.url_encoded ? 'URL ì¸ì½”ë”© ' : ''}
                            ${analysis.encoding_detected?.html_entities ? 'HTML ì—”í‹°í‹° ' : ''}
                            ${!analysis.encoding_detected?.url_encoded && !analysis.encoding_detected?.html_entities ? 'ì¸ì½”ë”© ì—†ìŒ' : ''}
                        </span>
                    </div>
                </div>
            </div>
        `;
    }

    // ê¶Œì¥ì‚¬í•­ ë Œë”ë§
    static renderRecommendations(recommendations) {
        if (!recommendations) return '<p>ê¶Œì¥ì‚¬í•­ ì—†ìŒ</p>';

        return `
            <ul class="recommendations-list">
                <li><strong>ì…ë ¥ ê²€ì¦:</strong> ${recommendations.input_validation}</li>
                <li><strong>ì¶œë ¥ ì¸ì½”ë”©:</strong> ${recommendations.output_encoding}</li>
                <li><strong>CSP í—¤ë”:</strong> ${recommendations.csp_headers}</li>
                <li><strong>ë³´ì•ˆ í”„ë ˆì„ì›Œí¬:</strong> ${recommendations.secure_frameworks}</li>
            </ul>
        `;
    }


    // ë©”ì¸ ë Œë”ë§ í•¨ìˆ˜
    static render(result) {
        const { vulnerability } = result;

        switch (vulnerability) {
            case 'sql-injection':
                return this.renderSQLInjection(result);
            case 'xss':
                return this.renderXSS(result);
            default:
                return `<div>ì•Œ ìˆ˜ ì—†ëŠ” ì·¨ì•½ì  ìœ í˜•: ${vulnerability}</div>`;
        }
    }
}