// ì·¨ì•½ì ë³„ ê²°ê³¼ ë Œë”ë§ ëª¨ë“ˆ
class VulnerabilityRenderer {

    // SQL Injection ê²°ê³¼ ë Œë”ë§
    static renderSQLInjection(result) {
        const { data, mode, language, requestData } = result;
        const server = SERVERS[language];
        const isVulnerable = mode === 'vulnerable';

        // ê³µê²© ì„±ê³µ ì—¬ë¶€ íŒë‹¨
        const attackSuccess = data?.result?.authentication_bypassed ||
                             data?.data?.attack_success ||
                             data?.success === true;

        return `
            <div class="vulnerability-section">
                <h4>ğŸ’‰ SQL Injection ë¶„ì„</h4>

                ${isVulnerable && attackSuccess ? `
                    <div class="alert alert-danger">
                        <strong>âš ï¸ ì¸ì¦ ìš°íšŒ ì„±ê³µ!</strong> SQL ì¸ì ì…˜ìœ¼ë¡œ ë¡œê·¸ì¸ì„ ìš°íšŒí–ˆìŠµë‹ˆë‹¤.
                    </div>
                ` : ''}

                <div class="vulnerability-principles">
                    <h5>ğŸ” ì·¨ì•½ì  ì›ë¦¬</h5>
                    <div class="principle-explanation">
                        <p><strong>SQL Injection</strong>ì€ ì‚¬ìš©ì ì…ë ¥ì„ SQL ì¿¼ë¦¬ì— ì§ì ‘ ì‚½ì…í•  ë•Œ ë°œìƒí•˜ëŠ” ì·¨ì•½ì ì…ë‹ˆë‹¤.</p>
                        <p>ê³µê²©ìê°€ ì•…ì„± SQL ì½”ë“œë¥¼ ì‚½ì…í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë¹„ì¸ê°€ëœ ë°©ë²•ìœ¼ë¡œ ì¡°ì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>

                <div class="code-section">
                    <h5>ğŸ“ ì·¨ì•½í•œ ì½”ë“œ ì˜ˆì‹œ</h5>
                    <pre><code class="language-sql">-- ì·¨ì•½í•œ ì¿¼ë¦¬ (ì‚¬ìš©ì ì…ë ¥ ì§ì ‘ ì‚½ì…)
SELECT * FROM users
WHERE username = '${requestData.username}'
  AND password = '${requestData.password}'

-- ì‹¤ì œ ì‹¤í–‰ëœ ì¿¼ë¦¬ (ì¸ì ì…˜ ì ìš©ë¨)
SELECT * FROM users
WHERE username = 'admin' OR '1'='1'
  AND password = '' OR '1'='1'</code></pre>
                </div>

                <div class="analysis-section">
                    <h5>ğŸ” ì·¨ì•½ì  ë¶„ì„</h5>
                    <ul>
                        <li><strong>ì›ì¸:</strong> ì‚¬ìš©ì ì…ë ¥ì„ SQL ì¿¼ë¦¬ì— ì§ì ‘ ì‚½ì…</li>
                        <li><strong>ê³µê²© ë²¡í„°:</strong> OR ì¡°ê±´ìœ¼ë¡œ ì¸ì¦ ìš°íšŒ</li>
                        <li><strong>ìœ„í—˜ë„:</strong> ë†’ìŒ (ë°ì´í„°ë² ì´ìŠ¤ ì „ì²´ ì ‘ê·¼ ê°€ëŠ¥)</li>
                    </ul>
                </div>

                <div class="mitigation-section">
                    <h5>ğŸ›¡ï¸ ë³´ì•ˆ ëŒ€ì±…</h5>
                    <pre><code class="language-php">// ì•ˆì „í•œ ì½”ë“œ (Prepared Statement)
$stmt = $pdo->prepare("SELECT * FROM users WHERE username = ? AND password = ?");
$stmt->execute([$username, $password]);</code></pre>
                </div>
            </div>
        `;
    }

    // XSS ê²°ê³¼ ë Œë”ë§
    static renderXSS(result) {
        const { data, mode, language, requestData } = result;
        const server = SERVERS[language];
        const isVulnerable = mode === 'vulnerable';

        const xssDetected = data?.result?.xss_detected;
        const htmlOutput = data?.result?.html_output;
        const riskLevel = data?.analysis?.risk_level || 'medium';

        return `
            <div class="vulnerability-section">
                <h4>ğŸ”¥ Cross-Site Scripting (XSS) ë¶„ì„</h4>

                ${isVulnerable && xssDetected ? `
                    <div class="alert alert-danger">
                        <strong>âš ï¸ XSS ì·¨ì•½ì  ë°œê²¬!</strong> ì•…ì„± ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤í–‰ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>
                ` : ''}

                <div class="vulnerability-principles">
                    <h5>ğŸ” ì·¨ì•½ì  ì›ë¦¬</h5>
                    <div class="principle-explanation">
                        <p><strong>Cross-Site Scripting (XSS)</strong>ëŠ” ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©ì ì…ë ¥ì„ ì œëŒ€ë¡œ ê²€ì¦í•˜ì§€ ì•Šì•„ ë°œìƒí•˜ëŠ” ì·¨ì•½ì ì…ë‹ˆë‹¤.</p>
                        <p>ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë°ì´í„°ê°€ ë¸Œë¼ìš°ì €ì—ì„œ ìŠ¤í¬ë¦½íŠ¸ë¡œ ì‹¤í–‰ë˜ì–´ ì¿ í‚¤ íƒˆì·¨, ì„¸ì…˜ í•˜ì´ì¬í‚¹, ì‚¬ì´íŠ¸ ë„ìš© ë“±ì˜ ê³µê²©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                    </div>
                </div>

                ${isVulnerable && htmlOutput ? `
                    <div class="xss-preview">
                        <h5>ğŸ¯ XSS ì‹¤í–‰ ê²°ê³¼</h5>
                        <div class="xss-demo-container">
                            <div class="demo-label">ì„œë²„ì—ì„œ ì²˜ë¦¬ëœ ê²°ê³¼:</div>
                            <div class="xss-output">${htmlOutput}</div>
                            <div class="xss-live-demo">
                                <strong>âš ï¸ ì‹¤ì œ XSS ì‹¤í–‰:</strong>
                                <div class="xss-execution-area">
                                    ${VulnerabilityRenderer.autoExecuteXSS(htmlOutput, requestData.payload)}
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <div class="code-section">
                    <h5>ğŸ“ ì·¨ì•½í•œ ì½”ë“œ ì˜ˆì‹œ</h5>
                    <pre><code class="language-php">// ì·¨ì•½í•œ ì½”ë“œ (ì…ë ¥ê°’ ì§ì ‘ ì¶œë ¥)
echo "<div>ì‚¬ìš©ì ì…ë ¥: " . $_POST['search'] . "</div>";

// ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’: ${requestData.payload}
// ê²°ê³¼: ${htmlOutput}</code></pre>
                </div>

                <div class="analysis-section">
                    <h5>ğŸ” í˜ì´ë¡œë“œ ë¶„ì„</h5>
                    ${this.renderPayloadAnalysis(data?.analysis?.payload_analysis)}
                </div>

                <div class="mitigation-section">
                    <h5>ğŸ›¡ï¸ ë³´ì•ˆ ëŒ€ì±…</h5>
                    <pre><code class="language-php">// ì•ˆì „í•œ ì½”ë“œ (HTML ì´ìŠ¤ì¼€ì´í”„)
echo "<div>ì‚¬ìš©ì ì…ë ¥: " . htmlspecialchars($_POST['search'], ENT_QUOTES, 'UTF-8') . "</div>";

// ë˜ëŠ” í…œí”Œë¦¿ ì—”ì§„ ì‚¬ìš©
echo $twig->render('search.html', ['query' => $search]);</code></pre>
                </div>

                <div class="recommendations-section">
                    <h5>ğŸ’¡ ê¶Œì¥ì‚¬í•­</h5>
                    ${this.renderRecommendations(data?.analysis?.recommendations)}
                </div>
            </div>
        `;
    }

    // í˜ì´ë¡œë“œ ë¶„ì„ ë Œë”ë§
    static renderPayloadAnalysis(analysis) {
        if (!analysis) return '<p>ë¶„ì„ ë°ì´í„° ì—†ìŒ</p>';

        return `
            <div class="payload-analysis">
                <div class="analysis-grid">
                    <div class="analysis-item">
                        <span class="label">í˜ì´ë¡œë“œ ê¸¸ì´:</span>
                        <span class="value">${analysis.length} ë¬¸ì</span>
                    </div>
                    <div class="analysis-item">
                        <span class="label">ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸:</span>
                        <span class="value ${analysis.contains_script_tags ? 'danger' : 'safe'}">
                            ${analysis.contains_script_tags ? 'âš ï¸ í¬í•¨' : 'âœ… ì—†ìŒ'}
                        </span>
                    </div>
                    <div class="analysis-item">
                        <span class="label">ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬:</span>
                        <span class="value">${analysis.contains_event_handlers} ê°œ</span>
                    </div>
                    <div class="analysis-item">
                        <span class="label">ì¸ì½”ë”© ìƒíƒœ:</span>
                        <span class="value">
                            ${analysis.encoding_detected?.url_encoded ? 'URL ì¸ì½”ë”© ' : ''}
                            ${analysis.encoding_detected?.html_entities ? 'HTML ì—”í‹°í‹° ' : ''}
                            ${!analysis.encoding_detected?.url_encoded && !analysis.encoding_detected?.html_entities ? 'ì¸ì½”ë”© ì—†ìŒ' : ''}
                        </span>
                    </div>
                </div>
            </div>
        `;
    }

    // ê¶Œì¥ì‚¬í•­ ë Œë”ë§
    static renderRecommendations(recommendations) {
        if (!recommendations) return '<p>ê¶Œì¥ì‚¬í•­ ì—†ìŒ</p>';

        return `
            <ul class="recommendations-list">
                <li><strong>ì…ë ¥ ê²€ì¦:</strong> ${recommendations.input_validation}</li>
                <li><strong>ì¶œë ¥ ì¸ì½”ë”©:</strong> ${recommendations.output_encoding}</li>
                <li><strong>CSP í—¤ë”:</strong> ${recommendations.csp_headers}</li>
                <li><strong>ë³´ì•ˆ í”„ë ˆì„ì›Œí¬:</strong> ${recommendations.secure_frameworks}</li>
            </ul>
        `;
    }

    // XSS ìë™ ì‹¤í–‰ (Vue ë²„ì „ê³¼ ë™ì¼)
    static autoExecuteXSS(htmlOutput, payload) {
        try {
            // XSS ê³µê²© ì„±ê³µ ì—¬ë¶€ ê°ì§€
            const hasScript = htmlOutput.includes('<script>') || htmlOutput.includes('javascript:') ||
                             htmlOutput.includes('onerror=') || htmlOutput.includes('onload=');
            const isVulnerable = hasScript && htmlOutput.includes(payload);

            if (isVulnerable) {
                // ì‹¤ì œ XSS ì‹¤í–‰
                setTimeout(() => {
                    executeXSSScript(htmlOutput);
                }, 500);

                return `
                    <div class="alert alert-success mb-3">
                        <i class="fas fa-check-circle"></i>
                        <strong>âœ… XSS ê³µê²© ì‹¤í–‰ë¨!</strong>
                        JavaScript alertê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.
                    </div>
                    ${htmlOutput}
                `;
            } else {
                return htmlOutput;
            }
        } catch (error) {
            console.error('XSS ìë™ ì‹¤í–‰ ì˜¤ë¥˜:', error);
            return htmlOutput;
        }
    }


    // ë©”ì¸ ë Œë”ë§ í•¨ìˆ˜
    static render(result) {
        const { vulnerability } = result;

        switch (vulnerability) {
            case 'sql-injection':
                return this.renderSQLInjection(result);
            case 'xss':
                return this.renderXSS(result);
            default:
                return `<div>ì•Œ ìˆ˜ ì—†ëŠ” ì·¨ì•½ì  ìœ í˜•: ${vulnerability}</div>`;
        }
    }
}

// XSS ë°ëª¨ ì‹¤í–‰ í•¨ìˆ˜ (ì „ì—­) - Vue ë²„ì „ê³¼ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì‹¤ì œ ì‹¤í–‰
function executeXSSDemo(payload, targetId) {
    const targetElement = document.getElementById(targetId);
    if (targetElement) {
        targetElement.innerHTML = '';

        try {
            // ì‹¤ì œ XSS ì‹¤í–‰ - Vue ë²„ì „ê³¼ ë™ì¼í•œ ë°©ì‹
            executeXSSScript(payload);

            // ì‹¤í–‰ ê²°ê³¼ í‘œì‹œ
            targetElement.innerHTML = `
                <div class="xss-execution-result">
                    <div class="xss-success">âœ… XSS ê³µê²© ì„±ê³µ!</div>
                    <div class="xss-effect">ì‹¤ì œ JavaScript ì½”ë“œê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                    <div class="xss-demo-html">${payload}</div>
                </div>
            `;
        } catch (error) {
            console.error('XSS ì‹¤í–‰ ì˜¤ë¥˜:', error);
            targetElement.innerHTML = `
                <div class="xss-execution-result">
                    <div class="xss-error">XSS ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: ${error.message}</div>
                </div>
            `;
        }
    }
}

// XSS ìŠ¤í¬ë¦½íŠ¸ ì‹¤ì œ ì‹¤í–‰ (Vue ë²„ì „ì—ì„œ ê°€ì ¸ì˜´)
function executeXSSScript(content) {
    try {
        // <script> íƒœê·¸ ë‚´ìš© ì¶”ì¶œ
        const scriptMatch = content.match(/<script[^>]*>(.*?)<\/script>/gi);
        if (scriptMatch) {
            scriptMatch.forEach(scriptTag => {
                const scriptContent = scriptTag.replace(/<script[^>]*>|<\/script>/gi, '');
                if (scriptContent.trim()) {
                    eval(scriptContent);
                }
            });
        }

        // ì¸ë¼ì¸ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì²˜ë¦¬ (onerror, onload ë“±)
        const eventMatches = content.match(/on\w+\s*=\s*['"](.*?)['"]/gi);
        if (eventMatches) {
            eventMatches.forEach(eventHandler => {
                const jsCode = eventHandler.replace(/on\w+\s*=\s*['"]|['"]/gi, '');
                if (jsCode.trim()) {
                    eval(jsCode);
                }
            });
        }

        // javascript: í”„ë¡œí† ì½œ ì²˜ë¦¬
        const jsProtocolMatch = content.match(/javascript:\s*(.*?)(?=['"\s>])/gi);
        if (jsProtocolMatch) {
            jsProtocolMatch.forEach(jsCode => {
                const code = jsCode.replace(/javascript:\s*/i, '');
                if (code.trim()) {
                    eval(code);
                }
            });
        }
    } catch (error) {
        console.log('XSS ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:', error.message);
        // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ì¼ë°˜ì ì¸ alertëŠ” ì‹¤í–‰
        if (content.includes('alert')) {
            const alertMatch = content.match(/alert\s*\(\s*['"`](.*?)['"`]\s*\)/);
            if (alertMatch) {
                alert(`XSS ê³µê²© ì„±ê³µ: ${alertMatch[1]}`);
            } else {
                alert('XSS ê³µê²©ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!');
            }
        }
    }
}

// XSS ì•Œë¦¼ ì‹œë®¬ë ˆì´ì…˜
function showXSSAlert(scriptContent) {
    // ì‹¤ì œ alert ëŒ€ì‹  ëª¨ë‹¬ë¡œ í‘œì‹œ
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    `;

    modal.innerHTML = `
        <div style="
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
        ">
            <h3 style="color: #dc3545; margin-bottom: 15px;">ğŸš¨ XSS ê³µê²© ì‹œë®¬ë ˆì´ì…˜</h3>
            <p style="margin-bottom: 15px;">ì‹¤ì œ ê³µê²©ì—ì„œëŠ” ë‹¤ìŒ ì½”ë“œê°€ ì‹¤í–‰ë©ë‹ˆë‹¤:</p>
            <code style="background: #f8f9fa; padding: 10px; border-radius: 4px; display: block; margin: 10px 0;">${scriptContent}</code>
            <button onclick="this.parentElement.parentElement.remove()" style="
                background: #dc3545;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
            ">ë‹«ê¸°</button>
        </div>
    `;

    document.body.appendChild(modal);

    // 3ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
        if (modal.parentElement) {
            modal.remove();
        }
    }, 5000);
}

// ì´ë¯¸ì§€ ì˜¤ë¥˜ ì‹œë®¬ë ˆì´ì…˜
function simulateImageError() {
    showXSSAlert('alert("XSS by image error!")');
}